name: CI/CD Pipeline - Test Stage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  backend-tests:
    name: Backend Tests (PHPUnit)
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
          MYSQL_USER: wordpress
          MYSQL_PASSWORD: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        extensions: mbstring, xml, curl, zip, gd, mysql, mysqli, pdo, pdo_mysql
        coverage: xdebug
        tools: composer
        
    - name: Validate composer.json
      run: composer validate --strict || composer validate
      continue-on-error: true
      
    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-interaction
      
    - name: Install MySQL client
      run: sudo apt-get update && sudo apt-get install -y mysql-client
      
    - name: Wait for MySQL to be ready
      run: |
        while ! mysqladmin ping -h"127.0.0.1" -P"3306" -u"wordpress" -p"wordpress" --silent; do
          echo "Waiting for MySQL..."
          sleep 2
        done
        echo "MySQL is ready!"
      env:
        MYSQL_PWD: wordpress
        
    - name: Create WordPress test database
      run: |
        mysql -h 127.0.0.1 -P 3306 -u wordpress -pwordpress -e "CREATE DATABASE IF NOT EXISTS wordpress_test;" || true
        mysql -h 127.0.0.1 -P 3306 -u wordpress -pwordpress -e "GRANT ALL PRIVILEGES ON wordpress_test.* TO 'wordpress'@'%';" || true
        mysql -h 127.0.0.1 -P 3306 -u wordpress -pwordpress -e "FLUSH PRIVILEGES;" || true
      env:
        MYSQL_PWD: wordpress
      continue-on-error: true
        
    - name: Download WordPress
      run: |
        if [ ! -d "wordpress" ] || [ ! -f "wordpress/wp-load.php" ]; then
          echo "Downloading WordPress..."
          curl -L -o wordpress.tar.gz https://wordpress.org/latest.tar.gz
          tar -xzf wordpress.tar.gz
          rm wordpress.tar.gz
          echo "WordPress downloaded successfully"
        else
          echo "WordPress directory already exists"
        fi
      continue-on-error: false
      
    - name: Set up WordPress test configuration
      run: |
        cat > wp-tests-config.php << 'EOF'
        <?php
        define('DB_NAME', 'wordpress_test');
        define('DB_USER', 'wordpress');
        define('DB_PASSWORD', 'wordpress');
        define('DB_HOST', '127.0.0.1:3306');
        define('DB_CHARSET', 'utf8');
        define('DB_COLLATE', '');
        define('WP_TESTS_DOMAIN', 'localhost');
        define('WP_TESTS_EMAIL', 'admin@example.org');
        define('WP_TESTS_TITLE', 'Test');
        define('WP_PHP_BINARY', 'php');
        define('WP_TESTS_FORCE_KNOWN_BUGS', true);
        define('WP_TESTS_TABLE_PREFIX', 'wp_test_');
        EOF
        echo "WordPress test configuration created"
        
    - name: Create test results directory
      run: |
        mkdir -p tests/results
        mkdir -p tests/results/coverage-html
        echo "Test results directory created"
        ls -la tests/results/
      
    - name: Run PHPUnit Tests
      run: |
        echo "Starting PHPUnit tests..."
        ./vendor/bin/phpunit \
          --configuration phpunit.xml \
          --log-junit tests/results/junit.xml \
          --coverage-clover tests/results/coverage.xml \
          --coverage-html tests/results/coverage-html \
          --testdox \
          --verbose \
          || echo "Tests completed with exit code: $?"
        
        echo ""
        echo "Checking generated files..."
        echo "JUnit XML exists: $([ -f tests/results/junit.xml ] && echo 'YES' || echo 'NO')"
        echo "Coverage XML exists: $([ -f tests/results/coverage.xml ] && echo 'YES' || echo 'NO')"
        echo "Coverage HTML dir exists: $([ -d tests/results/coverage-html ] && echo 'YES' || echo 'NO')"
        
        if [ -f tests/results/junit.xml ]; then
          echo "JUnit XML size: $(wc -l < tests/results/junit.xml) lines"
        fi
        
        if [ -d tests/results/coverage-html ]; then
          echo "Coverage HTML files: $(find tests/results/coverage-html -type f | wc -l)"
          ls -la tests/results/coverage-html/ | head -10
        fi
      env:
        WP_TESTS_DB_NAME: wordpress_test
        WP_TESTS_DB_USER: wordpress
        WP_TESTS_DB_PASSWORD: wordpress
        WP_TESTS_DB_HOST: 127.0.0.1:3306
        WP_TESTS_TABLE_PREFIX: wp_test_
        WORDPRESS_PATH: ./wordpress
        ABSPATH: ./wordpress/
        WP_USE_THEMES: false
        WP_DEBUG: true
        DB_NAME: wordpress_test
        DB_USER: wordpress
        DB_PASSWORD: wordpress
        DB_HOST: 127.0.0.1:3306
      continue-on-error: true
      
    - name: List generated files
      if: always()
      run: |
        echo "=========================================="
        echo "Checking for generated test files..."
        echo "=========================================="
        echo ""
        echo "Current directory: $(pwd)"
        echo ""
        echo "Tests/results directory contents:"
        ls -la tests/results/ 2>/dev/null || echo "Directory does not exist"
        echo ""
        echo "Checking specific files:"
        [ -f tests/results/junit.xml ] && echo "✓ junit.xml exists ($(wc -c < tests/results/junit.xml) bytes)" || echo "✗ junit.xml NOT found"
        [ -f tests/results/coverage.xml ] && echo "✓ coverage.xml exists ($(wc -c < tests/results/coverage.xml) bytes)" || echo "✗ coverage.xml NOT found"
        [ -d tests/results/coverage-html ] && echo "✓ coverage-html directory exists ($(find tests/results/coverage-html -type f | wc -l) files)" || echo "✗ coverage-html directory NOT found"
        echo ""
        if [ -d tests/results/coverage-html ]; then
          echo "Coverage HTML files:"
          find tests/results/coverage-html -type f | head -10
        fi
        echo "=========================================="
        
    - name: Generate test summary
      if: always()
      run: |
        echo "## Backend Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "tests/results/junit.xml" ]; then
          echo "✅ Test results generated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- JUnit XML: tests/results/junit.xml" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(wc -c < tests/results/junit.xml) bytes" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ JUnit XML not found" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "tests/results/coverage.xml" ]; then
          echo "- Coverage XML: tests/results/coverage.xml" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(wc -c < tests/results/coverage.xml) bytes" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Coverage XML not found" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "tests/results/coverage-html" ]; then
          echo "- Coverage HTML: tests/results/coverage-html/" >> $GITHUB_STEP_SUMMARY
          echo "- Files: $(find tests/results/coverage-html -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Coverage HTML directory not found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload test results (JUnit XML)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-junit
        path: tests/results/junit.xml
        retention-days: 30
        if-no-files-found: warn
      continue-on-error: true
        
    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-coverage-reports
        path: |
          tests/results/coverage.xml
          tests/results/coverage-html/
        retention-days: 30
        if-no-files-found: warn
      continue-on-error: true
      
    - name: Create detailed test report
      if: always()
      run: |
        mkdir -p test-artifacts
        echo "# Backend Test Execution Report" > test-artifacts/README.md
        echo "" >> test-artifacts/README.md
        echo "Generated: $(date)" >> test-artifacts/README.md
        echo "" >> test-artifacts/README.md
        echo "## Test Results" >> test-artifacts/README.md
        echo "" >> test-artifacts/README.md
        
        if [ -f tests/results/junit.xml ]; then
          echo "✅ JUnit XML Report: Available" >> test-artifacts/README.md
          echo "- Location: tests/results/junit.xml" >> test-artifacts/README.md
          echo "- Size: $(wc -c < tests/results/junit.xml) bytes" >> test-artifacts/README.md
          echo "- Lines: $(wc -l < tests/results/junit.xml)" >> test-artifacts/README.md
        else
          echo "❌ JUnit XML Report: Not generated" >> test-artifacts/README.md
        fi
        
        echo "" >> test-artifacts/README.md
        echo "## Coverage Reports" >> test-artifacts/README.md
        echo "" >> test-artifacts/README.md
        
        if [ -f tests/results/coverage.xml ]; then
          echo "✅ Coverage XML: Available" >> test-artifacts/README.md
          echo "- Location: tests/results/coverage.xml" >> test-artifacts/README.md
          echo "- Size: $(wc -c < tests/results/coverage.xml) bytes" >> test-artifacts/README.md
        else
          echo "❌ Coverage XML: Not generated" >> test-artifacts/README.md
        fi
        
        if [ -d tests/results/coverage-html ]; then
          echo "✅ Coverage HTML: Available" >> test-artifacts/README.md
          echo "- Location: tests/results/coverage-html/" >> test-artifacts/README.md
          echo "- Files: $(find tests/results/coverage-html -type f | wc -l)" >> test-artifacts/README.md
          echo "- Main file: tests/results/coverage-html/index.html" >> test-artifacts/README.md
        else
          echo "❌ Coverage HTML: Not generated" >> test-artifacts/README.md
        fi
        
        echo "" >> test-artifacts/README.md
        echo "## How to Use" >> test-artifacts/README.md
        echo "" >> test-artifacts/README.md
        echo "1. Download artifacts from GitHub Actions" >> test-artifacts/README.md
        echo "2. Extract the zip files" >> test-artifacts/README.md
        echo "3. Open coverage-html/index.html in a browser to view coverage" >> test-artifacts/README.md
        echo "4. Check junit.xml for test results" >> test-artifacts/README.md
        
    - name: Upload test artifacts documentation
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts-docs
        path: test-artifacts/
        retention-days: 30
        if-no-files-found: warn
      continue-on-error: true
        
    - name: Publish test results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: tests/results/junit.xml
        check_name: Backend Test Results
        report_individual_runs: true
        deduplicate_classes_by_file_name: true
        fail_on: 'nothing'
      continue-on-error: true
        
    - name: Test summary
      if: always()
      run: |
        echo "=========================================="
        echo "Backend Test Stage Completed"
        echo "=========================================="
        if [ -f "tests/results/junit.xml" ]; then
          echo "Test results: Available"
        else
          echo "Test results: Not generated"
        fi
        if [ -d "tests/results/coverage-html" ]; then
          echo "Coverage reports: Available"
        else
          echo "Coverage reports: Not generated"
        fi
        echo "=========================================="

